![image_not_found](pic/gateway_protocol.jpg)<br>
名词列表:<br>
AS(Autonomous System)<br>
位于单个机构控制下的所有路由器集合<br>
AS内部使用IGP进行路由, AS之间使用EGP进行路由<br>
机构连接上Internet需要获得ASN(AS Number)<br>
ASN最初版本为16 bytes, RFC 4893拓展到4 bytes<br>
private ASN:<br>
&emsp;&emsp;2 bytes: 64,512 - 65,535<br>
&emsp;&emsp;4 bytes: 4,200,000,000 - 4,294,967,294
<br>
<br>

BGP(Border Gateway Protocol)<br>
BGP属于EGP(Exterior Gateway Protocol)<br>
BGP用于在AS之间进行通信<br>
BGP使用TCP作为传输层协议, 并且使用TCP 179端口侦听<br>
位于AS边界的, 与其他AS通信的router, 称为BGP speaker<br>
不同AS之间的BGP speaker通信使用eBGP, 同一AS内的BGP speaker通信使用iBGP<br>
BGP Identifier为4字节无符号整数, 为某个IPv4值, 用于标识发送BGP信息的路由器
<br>
<br>

消息格式<br>
1.所有消息类型统一BGP header格式
```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                                                               +
|                           Marker                              |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Length               |      Type     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Marker
16 bytes, 用于兼容, 所有bits置1

Length
2 bytes, 无符号整数, 消息的总长度(包含header长度), 长度单位为bytes
长度范围限制在19~4096 bytes

Type
1 byte, 无符号整数, 指定消息类型. 列表如下:
    1 - OPEN
    2 - UPDATE
    3 - NOTIFICATION
    4 - KEEPALIVE
```

2.消息类型<br>
1)OPEN Message<br>
TCP连接建立后, 发送的第一个消息. 并且如果接收到OPEN Message并接受, 回复KEEPALIVE Message<br>

OPEN Message消息结构
```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+
|    Version    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     My Autonomous System      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Hold Time           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         BGP Identifier                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Opt Parm Len  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|             Optional Parameters (variable)                    |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Version
1 byte, 无符号整数, 标识协议版本号, 当前BGP版本为4

My Autonomous System
2 bytes, 无符号整数, 发送该消息router的ASN

Hold Time
2 bytes, 无符号整数, 接收者从自己的Hold Time配置和OPEN Message消息收到的值, 取较小值作为自己的Hold Timer

BGP Identifier
4 bytes, 无符号整数, BGP speaker的某个IPv4值, 在router启动时确定

Opt Parm Len
1 byte, 无符号整数, 代表后续所有可选参数的总长度, 长度单位为bytes

Optional Parameters
可选参数, 可指定多个可选参数, 每个可选参数包含以下字段:
    Parm Type - 1 byte
    Parm Length - 1 byte
    Parameter Value - variable length
```

2)UPDATE Message<br>
在BGP peer之间传输路由信息

UPDATE Message消息格式
```
+-----------------------------------------------------+
|   Withdrawn Routes Length (2 octets)                |
+-----------------------------------------------------+
|   Withdrawn Routes (variable)                       |
+-----------------------------------------------------+
|   Total Path Attribute Length (2 octets)            |
+-----------------------------------------------------+
|   Path Attributes (variable)                        |
+-----------------------------------------------------+
|   Network Layer Reachability Information (variable) |
+-----------------------------------------------------+

Withdrawn ROutes Length
2 bytes, 无符号整数, 后续Withdrawn Routes字段的长度, 长度单位为bytes

Withdrawn Routes
可变长度, 指定不可用的路由列表. 每个路由项内容如下:
    Length - 1 byte, 指定后续Prefix字段的长度, 单位为bits
    Prefix - 可变长度, IP地址的前置网络位, 需要字节对齐, 内容的bits不是8的整数倍时, 需要填充内容对齐

Total Path Attribute Length
2 bytes, 无符号整数, 后续Path Attributes的长度, 长度单位为bytes

Path Attributes
可变长度, 为路径属性列表. 每条路径属性包含内容如下:
    attribute type - 2 bytes, 由以下内容构成:
        attr flags - 1 byte, 构成内容如下:
            bit 0 - attribute为optional(1) or well-known(0)
            bit 1 - 对于optional attribute, transitive(1) or non-transitive(0); 对于well-known attribute, 必须为1
            bit 2 - 对于optional transitive attribute, partial(1) or complete(0); 对于optional non-transitive和well-known attribute, 必须为1
            bit 3 - Extended Length bit, attribute length is 1-byte(0) or 2-bytes(1)
            bit 4~7 - 保留bits
        attr type code - 1 byte,
    attribute length - 用于指定后续attribute value的长度, 长度单位为bytes. 当attr flags的bit 3为0时, 当前字段为1 byte; 当bit 3为1时, 该字段字段为2 bytes
    attribute value - 与type code搭配, 组成不同消息子类型. 具体参考表2
```


KEEPALIVE Message<br>
用于维持与peer的连接, 只有消息头部(19 bytes), 默认发送间隔时间为holder time的1/3
<br>

NOTIFICATION Message<br>
检测到错误, 发送错误, 然后立即关闭与peer的连接<br>
<br>
<br>
<br>

[1]IPv4 BGP(BGP-4): https://datatracker.ietf.org/doc/html/rfc4271

[2]IPv4 BGP usage: https://datatracker.ietf.org/doc/html/rfc1772

[3]BGP support for four-octet ASN: https://datatracker.ietf.org/doc/html/rfc4893

[4]IPv6 BGP: https://datatracker.ietf.org/doc/html/rfc4760
